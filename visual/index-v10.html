<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teleprompter Generator V10</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #0f0f0f; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .card { background: #1e1e1e; padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-width: 90%; width: 400px; border: 1px solid #333; }
        h1 { margin-bottom: 10px; color: #3498db; font-size: 1.8rem; }
        p { color: #888; margin-bottom: 30px; line-height: 1.5; }
        .upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block; margin-bottom: 20px; width: 100%; }
        .btn-upload { border: 2px dashed #444; color: #ccc; background-color: #252525; padding: 20px; border-radius: 10px; font-size: 1rem; font-weight: bold; width: 100%; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-upload:hover { background-color: #333; border-color: #3498db; color: white; }
        .btn-upload svg { width: 24px; height: 24px; fill: currentColor; }
        input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .generate-btn { background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; border: none; padding: 15px 30px; border-radius: 10px; font-size: 1.1rem; cursor: pointer; font-weight: bold; width: 100%; transition: transform 0.2s; display: none; }
        .generate-btn:active { transform: scale(0.98); }
        .footer { margin-top: 30px; font-size: 0.8rem; color: #555; }
    </style>
</head>
<body>

    <div class="card">
        <h1>Teleprompter V10</h1>
        <p>Genera tu App Offline.<br>Incluye fecha autom√°tica e icono.</p>
        
        <div class="upload-btn-wrapper">
            <button class="btn-upload" id="uploadBtnDisplay">
                <svg viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>
                Seleccionar Guion (.txt/.md)
            </button>
            <input type="file" id="fileInput" accept=".md,.txt">
        </div>

        <button class="generate-btn" id="generateBtn" onclick="generateApp()">
            ‚ö° Descargar App
        </button>
    </div>

    <div class="footer">Client-side Generator V10</div>

    <script>
        let fileContent = "";
        let fileName = "Teleprompter";

        // --- ICONO EN BASE64 (Una "T" azul simple para que no dependa de internet) ---
        const faviconBase64 = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' fill='%233498db'/%3E%3Cpath d='M160 120h192c17.67 0 32 14.33 32 32s-14.33 32-32 32h-64v224c0 17.67-14.33 32-32 32s-32-14.33-32-32V184h-64c-17.67 0-32-14.33-32-32s14.33-32 32-32z' fill='white'/%3E%3C/svg%3E";

        // 1. ESCUCHAR SELECCI√ìN
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(evt) {
                fileContent = evt.target.result;
                const lines = fileContent.split('\n');
                let foundTitle = "Teleprompter";
                for(let line of lines) {
                    let clean = line.replace(/[#*_]/g, '').trim();
                    if(clean.length > 0) {
                        foundTitle = clean.substring(0, 50);
                        break;
                    }
                }
                fileName = foundTitle.replace(/[^a-zA-Z0-9\s\u00C0-\u00FF]/g, '').trim();
                if(!fileName) fileName = "Teleprompter";

                document.getElementById('uploadBtnDisplay').innerHTML = `üìÑ ${fileName}`;
                document.getElementById('uploadBtnDisplay').style.borderColor = "#2ecc71";
                document.getElementById('uploadBtnDisplay').style.color = "#2ecc71";
                document.getElementById('generateBtn').style.display = "block";
            };
            reader.readAsText(file);
        });

        // 2. GENERAR Y DESCARGAR
        function generateApp() {
            const htmlContent = marked.parse(fileContent); 
            
            // Generar fecha actual para el nombre del archivo inicial
            const now = new Date();
            const timeString = now.getFullYear() +
                ("0" + (now.getMonth() + 1)).slice(-2) +
                ("0" + now.getDate()).slice(-2) + "_" +
                ("0" + now.getHours()).slice(-2) +
                ("0" + now.getMinutes()).slice(-2);
                
            const downloadName = `${fileName}_${timeString}.html`;

            // --- PLANTILLA MAESTRA V10 ---
            const template = `<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>${fileName}</title>

<link rel="icon" type="image/svg+xml" href="${faviconBase64}">
<link rel="apple-touch-icon" href="${faviconBase64}">

<meta property="og:title" content="${fileName}">
<meta property="og:description" content="Teleprompter Script - ${timeString}">
<meta property="og:type" content="article">
<meta property="og:image" content="https://via.placeholder.com/600x400.png?text=Teleprompter">

<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"><\/script>

<style>
    :root { --bg-app: #000000; --text-main: #ffffff; --panel-bg: #1a1a1a; --accent-green: #2ecc71; --accent-red: #e74c3c; --accent-blue: #3498db; --accent-orange: #e67e22; --accent-purple: #9b59b6; --link-color: #FFD700; --header-height: 60px; --footer-height: 90px; }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-app); color: var(--text-main); height: 100dvh; width: 100vw; overflow: hidden; }
    svg { width: 24px; height: 24px; fill: currentColor; display: block; }
    
    .top-bar { position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height); background-color: var(--panel-bg); border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; padding-top: env(safe-area-inset-top); z-index: 1000; }
    .logo { font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; color: white; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 60%; }
    .header-actions { display: flex; gap: 10px; }
    .btn-header { background: #333; color: white; border: 1px solid #555; padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 6px; }
    
    .control-bar { position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--panel-bg); border-top: 1px solid #333; display: flex; align-items: center; justify-content: center; gap: 10px; padding: 10px; padding-bottom: calc(15px + env(safe-area-inset-bottom)); z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.5); }
    .btn { border: none; color: white; font-weight: bold; border-radius: 10px; height: 46px; width: 46px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; font-size: 1.1rem; }
    .control-group { display: flex; background: #000; border-radius: 10px; border: 1px solid #333; overflow: hidden; align-items: center; height: 46px; }
    .display-val { width: 30px; text-align: center; font-size: 0.9rem; color: #ffffff; font-weight: bold; }
    .btn-mini { width: 40px; height: 100%; background: transparent; color: white; border: none; font-weight: bold; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center;}
    
    .btn-start { background-color: var(--accent-green); width: 60px; }
    .btn-start.paused { background-color: var(--accent-red); }
    .btn-reset { background-color: #444; }
    .bg-blue { background-color: var(--accent-blue); }
    .bg-orange { background-color: var(--accent-orange); }
    .btn-save { background-color: var(--accent-purple); margin-left: auto;}

    #teleprompter-area { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; scroll-behavior: auto; padding-top: calc(var(--header-height) + 20px); padding-bottom: calc(var(--footer-height) + 80px); padding-left: 20px; padding-right: 20px; -webkit-overflow-scrolling: touch; outline: none; }
    .content-width { max-width: 900px; margin: 0 auto; line-height: 1.6; font-weight: 500; margin-top: 20vh; }
    
    .markdown-body h1 { color: #ffeaa7; margin-top: 1.5em; font-size: 1.8em; border-bottom: 1px solid #333; padding-bottom: 10px;}
    .markdown-body h2 { color: #ffeaa7; margin-top: 1.2em; font-size: 1.4em; }
    .markdown-body p { margin-bottom: 1.5em; text-align: left; }
    .markdown-body ul { margin-left: 1.5em; margin-bottom: 1.5em; color: #ccc; }
    .markdown-body a { color: var(--link-color) !important; text-decoration: underline; text-underline-offset: 3px; }
    .markdown-body code { background: #333; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #f1c40f;}
    .markdown-body img { max-width: 100%; height: auto; display: block; margin: 10px auto; border-radius: 8px; }

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .modal-box { background: #222; width: 90%; max-width: 600px; height: 80%; border-radius: 12px; border: 1px solid #444; display: flex; flex-direction: column; padding: 20px; }
    .modal-textarea { flex: 1; background: #111; border: 1px solid #333; color: white; padding: 15px; font-size: 1rem; border-radius: 8px; resize: none; outline: none; font-family: monospace; }
    .modal-actions { display: flex; gap: 10px; margin-top: 15px; justify-content: flex-end; }
    .btn-modal { padding: 10px 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; color: white; }
    
    .reading-guide { position: fixed; top: 35%; left: 0; width: 100%; height: 0; border-top: 2px dashed rgba(255, 255, 255, 0.15); pointer-events: none; z-index: 500; }
    #status-overlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100px; height: 100px; color: rgba(255,255,255,0.8); pointer-events: none; z-index: 2000; opacity: 0; transition: opacity 0.3s; }
    #status-overlay svg { width: 100%; height: 100%; }

    /* ALERTA WHATSAPP */
    #whatsapp-warning {
        display: none;
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); z-index: 9999;
        flex-direction: column; align-items: center; justify-content: center;
        text-align: center; padding: 30px;
    }
    .arrow-hint { font-size: 3rem; color: #e74c3c; animation: bounce 1s infinite; margin-bottom: 20px; position:absolute; top: 20px; right: 20px; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(10px); } }
</style>
</head>
<body>

    <div style="display: none;">
        <svg id="icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        <svg id="icon-pause" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
        <svg id="icon-reset" viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>
        <svg id="icon-save" viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
        <svg id="icon-paste" viewBox="0 0 24 24"><path d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/></svg>
    </div>

    <div id="whatsapp-warning">
        <div class="arrow-hint">‚ÜóÔ∏è</div>
        <h2 style="color:white">Navegador Limitado</h2>
        <p style="font-size: 1.2rem; color: #ccc; margin-top:20px;">
            Est√°s en WhatsApp/Facebook.<br>
            Toca los <strong>3 puntos</strong> y elige:<br><br>
            <span style="color: #2ecc71; border:1px solid #2ecc71; padding:5px 10px; border-radius:5px;">Abrir en Navegador</span>
        </p>
    </div>

    <div id="pasteModal" class="modal-overlay"><div class="modal-box"><div class="modal-header" style="color:white; font-weight:bold; margin-bottom:10px;">Paste Text</div><textarea id="pasteInput" class="modal-textarea" placeholder="Paste your text here..."></textarea><div class="modal-actions"><button class="btn-modal" style="background:#444; color:white" onclick="closePasteModal()">Cancel</button><button class="btn-modal" style="background:#2ecc71" onclick="renderPaste()">Load</button></div></div></div>

    <nav class="top-bar">
        <div class="logo">
            <svg viewBox="0 0 512 512" style="color:var(--accent-blue)"><rect width="512" height="512" rx="100" fill="currentColor"/><path d="M160 120h192c17.67 0 32 14.33 32 32s-14.33 32-32 32h-64v224c0 17.67-14.33 32-32 32s-32-14.33-32-32V184h-64c-17.67 0-32-14.33-32-32s14.33-32 32-32z" fill="white"/></svg>
            <span>${fileName}</span>
        </div>
        <div class="header-actions">
            <button class="btn-header" onclick="openPasteModal()">Paste</button>
            <button class="btn-header" onclick="document.getElementById('fileInputApp').click()">Upload</button>
        </div>
    </nav>

    <div id="status-overlay"></div><div class="reading-guide"></div>

    <div id="teleprompter-area" onclick="handleAreaClick(event)">
        <div id="content" class="content-width markdown-body">
            <div id="raw-markdown" style="display:none">${fileContent.replace(/`/g, '\\`').replace(/\$/g, '\\$')}</div>
        </div>
    </div>
    
    <input type="file" id="fileInputApp" accept=".md,.txt" style="display:none">

    <div class="control-bar">
        <button class="btn btn-start" id="btnToggle" onclick="toggleScroll(event)"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
        <button class="btn btn-reset" onclick="resetScroll()"><svg viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg></button>
        <div class="control-group bg-blue"><button class="btn-mini" onclick="adjustSpeed(-1)">-</button><span class="display-val" id="speedDisplay" style="color:white">4</span><button class="btn-mini" onclick="adjustSpeed(1)">+</button></div>
        <div class="control-group bg-orange"><button class="btn-mini" onclick="adjustSize(-2)">-</button><span class="display-val"><svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:white"><path d="M2.5 4v3h5v12h3V7h5V4h-13zm19 5h-9v3h3v7h3v-7h3V9z"/></svg></span><button class="btn-mini" onclick="adjustSize(2)">+</button></div>
        <button class="btn btn-save" onclick="saveDocument()"><svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg></button>
    </div>

    <script>
    // DETECTOR WHATSAPP
    const ua = navigator.userAgent || navigator.vendor || window.opera;
    if (/WhatsApp|FBAN|FBAV|Instagram/.test(ua)) { document.getElementById('whatsapp-warning').style.display = 'flex'; }

    // VARS
    let isMobile=window.innerWidth<768;let isScrolling=false;let scrollSpeed=4;let fontSize=isMobile?24:42;let animationId;let lastTime=0;let accumulator=0;let loadedName="${fileName}";
    const area=document.getElementById('teleprompter-area');const content=document.getElementById('content');const btnToggle=document.getElementById('btnToggle');const speedDisplay=document.getElementById('speedDisplay');const overlay=document.getElementById('status-overlay');const modal=document.getElementById('pasteModal');const pasteInput=document.getElementById('pasteInput');
    const svgPlay='<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';const svgPause='<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';const svgRotate='<svg viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>';

    // INIT AUTO-START
    content.style.fontSize=fontSize+"px";
    const rawMD=document.getElementById('raw-markdown').innerText;
    if(rawMD.trim().length > 0){ 
        try{content.innerHTML=marked.parse(rawMD)}catch(e){content.innerText=rawMD}
        area.scrollTop=0; 
        setTimeout(()=>{ if(!isScrolling) startScroll() }, 2000); // 2 segundos auto-start
    }

    // EVENTS
    document.getElementById('fileInputApp').addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;loadedName=f.name.replace(/\.[^/.]+$/,"");const r=new FileReader();r.onload=evt=>{loadMarkdown(evt.target.result)};r.readAsText(f)});
    function openPasteModal(){modal.style.display='flex';pasteInput.focus()}
    function closePasteModal(){modal.style.display='none'}
    function renderPaste(){const t=pasteInput.value;if(t.trim().length>0){loadedName="Paste";loadMarkdown(t);closePasteModal()}}
    function loadMarkdown(t){try{content.innerHTML=marked.parse(t)}catch(e){content.innerText=t}area.scrollTop=0;showFeedback(svgRotate); setTimeout(()=>{if(!isScrolling)startScroll()},2000);}
    
    // SCROLL ENGINE (x7 Turbo)
    document.addEventListener('keydown',(e)=>{if(e.code==='Space'){e.preventDefault();toggleScroll()}});
    function handleAreaClick(e){if(e.target.closest('button')||e.target.closest('.modal-box')||e.target.tagName==='A')return;toggleScroll()}
    function step(ts){if(!isScrolling)return;if(!lastTime)lastTime=ts;const d=ts-lastTime;lastTime=ts;const pps=scrollSpeed*7;const m=(pps*d)/1000;accumulator+=m;if(accumulator>=1){const pts=Math.floor(accumulator);area.scrollTop+=pts;accumulator-=pts}if(area.scrollTop+area.clientHeight>=area.scrollHeight-1)stopScroll();else animationId=requestAnimationFrame(step)}
    function toggleScroll(e){if(e)e.stopPropagation();isScrolling?stopScroll():startScroll()}
    function startScroll(){if(isScrolling)return;isScrolling=true;lastTime=0;accumulator=0;btnToggle.innerHTML=svgPause;btnToggle.classList.add('paused');showFeedback(svgPlay);animationId=requestAnimationFrame(step)}
    function stopScroll(){isScrolling=false;cancelAnimationFrame(animationId);btnToggle.innerHTML=svgPlay;btnToggle.classList.remove('paused');showFeedback(svgPause)}
    function resetScroll(){stopScroll();area.scrollTop=0;accumulator=0;showFeedback(svgRotate)}
    function adjustSpeed(d){let s=scrollSpeed+d;if(s<1)s=1;if(s>50)s=50;scrollSpeed=s;speedDisplay.innerText=s}
    function adjustSize(d){let s=fontSize+d;if(s<12)s=12;if(s>150)s=150;fontSize=s;content.style.fontSize=fontSize+"px"}
    function showFeedback(i){overlay.innerHTML=i;overlay.style.opacity="1";overlay.style.transform="translate(-50%, -50%) scale(1.2)";setTimeout(()=>{overlay.style.opacity="0";overlay.style.transform="translate(-50%, -50%) scale(1)"},600)}
    
    // GUARDADO CON FECHA Y HORA
    function saveDocument(){
        const now = new Date();
        const timeStamp = now.getFullYear() +
            ("0" + (now.getMonth() + 1)).slice(-2) +
            ("0" + now.getDate()).slice(-2) + "_" +
            ("0" + now.getHours()).slice(-2) +
            ("0" + now.getMinutes()).slice(-2);
            
        const cleanName = loadedName.replace(/[^a-zA-Z0-9\s]/g, '').trim();
        const finalFileName = \`\${cleanName}_\${timeStamp}.html\`;

        // Clonamos la l√≥gica para guardarla dentro
        const styles = document.querySelector('style').innerHTML;
        const contentHTML = content.innerHTML; 
        const favicon = "${faviconBase64}"; 
        
        const fileContent = \`<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
        <title>\${loadedName}</title>
        <link rel="icon" type="image/svg+xml" href="\${favicon}">
        <meta property="og:title" content="\${loadedName}">
        <meta property="og:description" content="Generado el \${timeStamp}">
        <meta property="og:type" content="article">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"><\\/script><style>\${styles}</style></head><body>
        
        <div id="pasteModal" class="modal-overlay"><div class="modal-box"><div class="modal-header"><span>Paste Text Script</span><div onclick="closePasteModal()" style="cursor:pointer; opacity:0.7"><svg viewBox="0 0 24 24" style="width:20px;height:20px"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></div></div><textarea id="pasteInput" class="modal-textarea" placeholder="Paste your text here..."></textarea><div class="modal-actions"><button class="btn-modal btn-cancel" onclick="closePasteModal()">Cancel</button><button class="btn-modal btn-confirm" onclick="renderPaste()">Load Script</button></div></div></div>
        <nav class="top-bar"><div class="logo"><svg viewBox="0 0 512 512" style="color:var(--accent-blue)"><rect width="512" height="512" rx="100" fill="currentColor"/><path d="M160 120h192c17.67 0 32 14.33 32 32s-14.33 32-32 32h-64v224c0 17.67-14.33 32-32 32s-32-14.33-32-32V184h-64c-17.67 0-32-14.33-32-32s14.33-32 32-32z" fill="white"/></svg><span>\${loadedName}</span></div><div class="header-actions"><button class="btn-header" onclick="openPasteModal()">Paste</button><button class="btn-header" onclick="document.getElementById('fileInputApp').click()">Upload</button></div></nav>
        <div id="whatsapp-warning"><div class="arrow-hint">‚ÜóÔ∏è</div><h2 style="color:white">Navegador Limitado</h2><p style="font-size: 1.2rem; color: #ccc; margin-top:20px;">Est√°s en WhatsApp/Facebook.<br>Toca los <strong>3 puntos</strong> y elige:<br><br><span style="color: #2ecc71; border:1px solid #2ecc71; padding:5px 10px; border-radius:5px;">Abrir en Navegador</span></p></div>
        <div id="status-overlay"></div><div class="reading-guide"></div>
        <div id="teleprompter-area" onclick="handleAreaClick(event)"><div id="content" class="content-width markdown-body" style="font-size: \${fontSize}px;">\${contentHTML}</div></div>
        <input type="file" id="fileInputApp" accept=".md,.txt" style="display:none">
        <div class="control-bar"><button class="btn btn-start" id="btnToggle" onclick="toggleScroll(event)">${svgPlay}</button><button class="btn btn-reset" onclick="resetScroll()"><svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:white"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg></button><div class="control-group bg-blue"><button class="btn-mini" onclick="adjustSpeed(-1)">-</button><span class="display-val" id="speedDisplay" style="color:white">\${scrollSpeed}</span><button class="btn-mini" onclick="adjustSpeed(1)">+</button></div><div class="control-group bg-orange"><button class="btn-mini" onclick="adjustSize(-2)">-</button><span class="display-val"><svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:white"><path d="M2.5 4v3h5v12h3V7h5V4h-13zm19 5h-9v3h3v7h3v-7h3V9z"/></svg></span><button class="btn-mini" onclick="adjustSize(2)">+</button></div><button class="btn btn-save" onclick="saveDocument()"><svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:white"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg></button></div>
        
        <script>
        const ua = navigator.userAgent || navigator.vendor || window.opera; if (/WhatsApp|FBAN|FBAV|Instagram/.test(ua)) { document.getElementById('whatsapp-warning').style.display = 'flex'; }
        let isMobile=window.innerWidth<768;let isScrolling=false;let scrollSpeed=\${scrollSpeed};let fontSize=\${fontSize};let animationId;let lastTime=0;let accumulator=0;let loadedName="\${loadedName}";
        const area=document.getElementById('teleprompter-area');const content=document.getElementById('content');const btnToggle=document.getElementById('btnToggle');const speedDisplay=document.getElementById('speedDisplay');const overlay=document.getElementById('status-overlay');const modal=document.getElementById('pasteModal');const pasteInput=document.getElementById('pasteInput');
        const svgPlay = '${svgPlay}'; const svgPause = '${svgPause}'; const svgRotate = '${svgRotate}';
        
        // AUTO START EN ARCHIVO GUARDADO
        window.onload = function() { setTimeout(()=>{ if(!isScrolling) startScroll() }, 2000); };
        
        document.getElementById('fileInputApp').addEventListener('change',e=>{const file=e.target.files[0];if(!file)return;loadedName=file.name.replace(/\.[^/.]+$/,"");const reader=new FileReader();reader.onload=evt=>{loadMarkdown(evt.target.result)};reader.readAsText(file)});
        function openPasteModal(){modal.style.display='flex';pasteInput.focus()}
        function closePasteModal(){modal.style.display='none'}
        function renderPaste(){const text=pasteInput.value;if(text.trim().length>0){loadedName="Pasted Script";loadMarkdown(text);closePasteModal()}}
        function loadMarkdown(text){try{content.innerHTML=marked.parse(text)}catch(err){content.innerText=text}area.scrollTop=0;showFeedback(svgRotate); setTimeout(()=>{if(!isScrolling)startScroll()},2000);}
        document.addEventListener('keydown',(e)=>{if(e.code==='Space'){e.preventDefault();toggleScroll()}});
        function handleAreaClick(e){if(e.target.closest('button')||e.target.closest('.modal-box')||e.target.tagName==='A')return;toggleScroll()}
        function step(timestamp){if(!isScrolling)return;if(!lastTime)lastTime=timestamp;const delta=timestamp-lastTime;lastTime=timestamp;const pxPerSec=scrollSpeed*7;const move=(pxPerSec*delta)/1000;accumulator+=move;if(accumulator>=1){const pixelsToScroll=Math.floor(accumulator);area.scrollTop+=pixelsToScroll;accumulator-=pixelsToScroll}if(area.scrollTop+area.clientHeight>=area.scrollHeight-1)stopScroll();else animationId=requestAnimationFrame(step)}
        function toggleScroll(e){if(e)e.stopPropagation();isScrolling?stopScroll():startScroll()}
        function startScroll(){if(isScrolling)return;isScrolling=true;lastTime=0;accumulator=0;btnToggle.innerHTML=svgPause;btnToggle.classList.add('paused');showFeedback(svgPlay);animationId=requestAnimationFrame(step)}
        function stopScroll(){isScrolling=false;cancelAnimationFrame(animationId);btnToggle.innerHTML=svgPlay;btnToggle.classList.remove('paused');showFeedback(svgPause)}
        function resetScroll(){stopScroll();area.scrollTop=0;accumulator=0;showFeedback(svgRotate)}
        function adjustSpeed(delta){let s=scrollSpeed+delta;if(s<1)s=1;if(s>50)s=50;scrollSpeed=s;speedDisplay.innerText=s}
        function adjustSize(delta){let s=fontSize+delta;if(s<12)s=12;if(s>150)s=150;fontSize=s;content.style.fontSize=fontSize+"px"}
        function showFeedback(icon){overlay.innerHTML=icon;overlay.style.opacity="1";overlay.style.transform="translate(-50%, -50%) scale(1.2)";setTimeout(()=>{overlay.style.opacity="0";overlay.style.transform="translate(-50%, -50%) scale(1)"},600)}
        // Recursion para guardado sucesivo
        function saveDocument(){ alert('Usa el generador original para crear copias limpias.'); }
        <\\/script></body></html>\`;
        
        const blob = new Blob([fileContent], {type: 'text/html'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = finalFileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        }
    </script>
</body>
</html>`;

            const blob = new Blob([template], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = downloadName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
